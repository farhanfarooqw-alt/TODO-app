<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Todo App</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .task-completed { @apply line-through text-gray-500 bg-gray-50; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen py-10 px-4">

  <div class="max-w-2xl mx-auto bg-white rounded-xl shadow-md overflow-hidden">

    <!-- Header + Add Form -->
    <div class="p-6 border-b">
      <h1 class="text-2xl font-bold text-gray-800 mb-4">Todo App</h1>

      <form id="add-form" class="space-y-3">
        <input 
          type="text" 
          id="title" 
          placeholder="Task title (required)" 
          required
          class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
        >
        <textarea 
          id="description" 
          placeholder="Description (optional)" 
          rows="2"
          class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
        ></textarea>
        <button 
          type="submit"
          class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 font-medium"
        >
          Add Task
        </button>
      </form>
    </div>

    <!-- Tasks List -->
    <div class="p-6">
      <ul id="task-list" class="space-y-3"></ul>
      <p id="empty-message" class="text-center text-gray-500 py-8 hidden">
        No tasks yet. Add your first one above!
      </p>
    </div>

  </div>

  <script>
    const API_BASE = '/api';
    const taskList = document.getElementById('task-list');
    const emptyMsg = document.getElementById('empty-message');
    const addForm = document.getElementById('add-form');

    async function fetchTasks() {
      const res = await fetch(`${API_BASE}/tasks`);
      if (!res.ok) throw new Error('Failed to fetch tasks');
      return await res.json();
    }

    function renderTasks(tasks) {
      taskList.innerHTML = '';
      if (tasks.length === 0) {
        emptyMsg.classList.remove('hidden');
        return;
      }
      emptyMsg.classList.add('hidden');

      tasks.forEach(task => {
        const li = document.createElement('li');
        li.className = `p-4 border rounded-lg flex flex-col sm:flex-row sm:items-start justify-between gap-3 ${task.completed ? 'task-completed' : 'bg-white'}`;

        li.innerHTML = `
          <div class="flex-1">
            <div class="flex items-start gap-3">
              <input 
                type="checkbox" 
                ${task.completed ? 'checked' : ''} 
                class="mt-1.5 w-5 h-5 text-blue-600 rounded"
                onchange="toggleComplete('${task.id}', this.checked)"
              >
              <div>
                <h3 class="font-medium text-gray-900">${task.title}</h3>
                ${task.description ? `<p class="text-gray-600 mt-1 text-sm">${task.description}</p>` : ''}
              </div>
            </div>
          </div>

          <div class="flex gap-3 self-start sm:self-center">
            <button 
              onclick="editTask('${task.id}', '${escapeHtml(task.title)}', '${escapeHtml(task.description || '')}')"
              class="text-blue-600 hover:text-blue-800 text-sm font-medium"
            >
              Edit
            </button>
            <button 
              onclick="deleteTask('${task.id}')"
              class="text-red-600 hover:text-red-800 text-sm font-medium"
            >
              Delete
            </button>
          </div>
        `;
        taskList.appendChild(li);
      });
    }

    function escapeHtml(unsafe) {
      return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    }

    async function loadTasks() {
      try {
        const tasks = await fetchTasks();
        // Already sorted by created_at DESC from backend
        renderTasks(tasks);
      } catch (err) {
        alert('Error loading tasks: ' + err.message);
      }
    }

    // Add new task
    addForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const title = document.getElementById('title').value.trim();
      const description = document.getElementById('description').value.trim();

      if (!title) return alert('Title is required');

      try {
        await fetch(`${API_BASE}/tasks`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ title, description })
        });
        addForm.reset();
        loadTasks();
      } catch (err) {
        alert('Failed to add task');
      }
    });

    // Toggle complete
    window.toggleComplete = async (id, completed) => {
      try {
        await fetch(`${API_BASE}/tasks/${id}/complete`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ completed })
        });
        loadTasks();
      } catch (err) {
        alert('Failed to update task');
      }
    };

    // Edit task
    window.editTask = async (id, currentTitle, currentDesc) => {
      const newTitle = prompt('Edit title:', currentTitle);
      if (newTitle === null) return;

      const newDesc = prompt('Edit description (leave empty to remove):', currentDesc);

      try {
        await fetch(`${API_BASE}/tasks/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            title: newTitle.trim() || currentTitle,
            description: newDesc?.trim() || null
          })
        });
        loadTasks();
      } catch (err) {
        alert('Failed to update task');
      }
    };

    // Delete task
    window.deleteTask = async (id) => {
      if (!confirm('Delete this task?')) return;
      try {
        await fetch(`${API_BASE}/tasks/${id}`, { method: 'DELETE' });
        loadTasks();
      } catch (err) {
        alert('Failed to delete task');
      }
    };

    // Initial load
    loadTasks();
  </script>
</body>
</html>         